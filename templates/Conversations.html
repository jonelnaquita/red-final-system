{% extends "base.html" %}

<html>
<body>
{% block content%}
<head>
    <link rel="stylesheet" href="/static/css/custom/chat.css" >
</head>
    <div class="main-panel">
        <div class="content-wrapper">
            <div class="row">
                <div class="col grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Messages</h4>
                            <p class="card-description">Input description here!</p>
                            <div class="messaging">
                                <div class="inbox_msg">
                                    <div class="inbox_people">
                                        <div class="inbox_chat">
                                            {% for session in sessions %}
                                                <div class="chat_list tab-pane" data-session-id="{{ session.sessionID }}">
                                                    <div class="chat_people">
                                                        <div class="chat_ib">
                                                            <input type="hidden" value="{{ session.sessionID }}">
                                                            <h5>{{ session.incomingMessage if session.incomingMessage else session.botMessage }}</h5>
                                                            <p><span class="chat_date">{{ session.timestamp }}</span></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="mesgs" style="">
                                        <div class="msg_history">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        //Function to load conversation when a chat list was clicked
        document.querySelectorAll('.chat_list').forEach(function(chatList) {
            chatList.addEventListener('click', function() {
                var sessionId = chatList.getAttribute('data-session-id');
        
                fetch('/conversations/' + sessionId)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(function(conversation) {
                        var mesgs = document.querySelector('.mesgs .msg_history');
                        mesgs.innerHTML = '';
        
                        conversation.forEach(function(message) {
                            var messageHtml = `
                                <div class="incoming_msg">
                                    <div class="received_msg">
                                        <div class="received_withd_msg">
                                            <p>${message.incomingMessage}</p>
                                            <span class="time_date">${message.timestamp}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="outgoing_msg">
                                    <div class="incoming_msg_img float-right">
                                        <img src="/static/assets/images/RED_Logo.png" alt="red-logo">
                                    </div>
                                    <div class="sent_msg">
                                        <p>${message.botMessage}</p>
                                        <span class="time_date">${message.timestamp}</span>
                                    </div>
                                </div>
                            `;
                            mesgs.innerHTML += messageHtml;
                        });
                    })
                    .catch(function(error) {
                        console.error(error);
                    });
            });
        });
    </script>

    <script>
        // Function to load the most recent conversation for the first chat session when the page loads
        function loadMostRecentConversation() {
            // Check if there is at least one chat session
            var chatLists = document.querySelectorAll('.chat_list');
            if (chatLists.length > 0) {
                var firstChatList = chatLists[0];
                var sessionId = firstChatList.getAttribute('data-session-id');
    
                // Add 'active_chat' class to the first chat_list element
                firstChatList.classList.add('active_chat');
    
                fetch('/conversations/' + sessionId)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(function(conversation) {
                        var mesgs = document.querySelector('.mesgs .msg_history');
                        mesgs.innerHTML = '';
    
                        conversation.forEach(function(message) {
                            var messageHtml = `
                                <div class="incoming_msg">
                                    <div class="received_msg">
                                        <div class="received_withd_msg">
                                            <p>${message.incomingMessage}</p>
                                            <span class="time_date">${message.timestamp}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="outgoing_msg">
                                    <div class="incoming_msg_img float-right">
                                        <img src="/static/assets/images/RED_Logo.png" alt="red-logo">
                                    </div>
                                    <div class="sent_msg">
                                        <p>${message.botMessage}</p>
                                        <span class="time_date">${message.timestamp}</span>
                                    </div>
                                </div>
                            `;
                            mesgs.innerHTML += messageHtml;
                        });
                    })
                    .catch(function(error) {
                        console.error(error);
                    });
            }
        }
    
        // Call the function to load the most recent conversation when the page loads
        window.addEventListener('load', loadMostRecentConversation);
    </script>
    
    <script>
        document.querySelectorAll('.chat_list').forEach(function(chatList) {
            chatList.addEventListener('click', function() {
                document.querySelectorAll('.chat_list').forEach(function(element) {
                    element.classList.remove('active_chat');
                });
                chatList.classList.add('active_chat');
            });
            chatList.addEventListener('mouseover', function() {
                chatList.style.cursor = 'pointer';
            });
            chatList.addEventListener('mouseout', function() {
                chatList.style.cursor = 'default';
            });
        });
    </script>
{% endblock %}
</body>

{% block scripts %}

{% endblock %}

</html>